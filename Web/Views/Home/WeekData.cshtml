@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row InfoHead">
    <div class="col-md-9">
        <h2>
            Weekly Trend
        </h2>
    </div>
</div>

<div class="wrapper">
@using (Html.BeginForm("QueryWeekData", "Query",
                        FormMethod.Post, new { @id = "frmQueryWeekData" }))
{
    <div class="row">
        <div class="col-md-3">
            <span>WareHouse</span>
            <span>
                <select id="idSelBu" name="bu" required>
                    <option></option>
                </select>
            </span>
        </div>
        <div class="col-md-3">
            <span>Start Week</span>
            <span>
                <select id="idSelStartWeek" name="startDate" required>
                    <option></option>
                </select>
            </span>
        </div>
        <div class="col-md-3">
            <span>End Week</span>
            <span>
                <select id="idSelEndWeek" name="endDate" required>
                    <option></option>
                </select>
            </span>            
        </div>
        <div class="col-md-3">
            @Html.ValidationSummary(false, "", new { @class = "text-danger" })
            <button class="btn btn-info" type="submit">Query</button>
        </div>
    </div>
}
</div>

<div id="gridcontainer" style="overflow-x:scroll">
    <table id="idTable" class="table table-striped table-bordered table-hover dataTable">
    </table>
</div>
<br/>
<hr/>
<div class="wrapper">
    <div class="row">
        <div id="idChart" style="height:500px;"></div>
    </div>
</div>


@section Scripts{
    <script>
        var oidTable =null;
        var weekChart=null;
        var weekData =null;

        $(function () {
            InitData();
            weekChart = echarts.init(document.getElementById("idChart"));
        });

        function InitData() {
            var url = "@Url.Action("GetWeekDataInitInfo", "Query")";
            AjaxPost(url,
                "{}",
                true,
                function (result) {
                    var warehouseList = result.data || [];
                    var weekdateList = result.extra || [];
                    $("#idSelBu").select2({
                        data: warehouseList,
                        placeholder: "choose a warehouse...",
                        width: "120px"
                    });
                    selectorBu = new TSelect2Helper($("#idSelBu"));

                    $("#idSelStartWeek").select2({
                        data: weekdateList,
                        placeholder: "choose...",
                        width: "120px"
                    });
                    selectorStartWeek = new TSelect2Helper($("#idSelStartWeek"));

                    $("#idSelEndWeek").select2({
                        data: weekdateList,
                        placeholder: "choose...",
                        width: "120px"
                    });
                    selectorEndWeek = new TSelect2Helper($("#idSelEndWeek"));

                });

            $('#frmQueryWeekData').on('submit', function (e) {
                if (e.isDefaultPrevented()) {
                    //invalid
                    return false;
                } else {
                    var url = $(this).attr("action");
                    AjaxPostForm(url, '#frmQueryWeekData', true, function (resp) {
                        if (resp.bok) {
                            EmptyTable();
                            weekData = {
                                'columns': resp.data.columns,
                                'kinds': resp.data.kinds,
                                'data': JSON.parse(resp.data.data)                                
                            };
                            RefreshTable(weekData);
                            RefreshChart();
                        } else {
                            EmptyTable();
                            BootstrapDialog.alert("查询失败:<br>" + resp.msg);
                        }
                    },
                    undefined,
                    function () {
                        showBusyLoading(true);
                    },
                    function () {
                        showBusyLoading(false);
                    });
                }
                return false;
            });
        }

        function EmptyTable() {
            if (oidTable) {
                oidTable.destroy();
            }
            $('#idTable').empty();
        }
        function RefreshTable(tdata) {
            //console.log('tdata: ' + tdata);
            var cols = tdata.columns;
            var colDefs = [];
            var rows = tdata.data;
            oidTable = $('#idTable').DataTable(
                                {
                                    data: rows,
                                    columns: cols,
                                    columnDefs: colDefs,
                                    autoWidth: true,
                                    destroy: true,
                                    paging: true,
                                    ordering: false,
                                    searching: false
                                });
        }
        
        function MakexAxis() {
            var xCols = [];
            $.each( weekData.columns, function (index, value) {
                xCols.push(value.data);
            });
            return xCols.slice(1);
        }
        function MakeChartData() {
            var chartData = [];

            $.each(weekData.data, function (index, value) {
                var vArr = MakeValueArr(value);
                var objChart = { 'name': vArr[0], 'type': 'line', 'stack': '总量', 'data': vArr.slice(1) };
                if (objChart.name == 'HC_Utilization') {
                    objChart.yAxisIndex = 1;
                }
                chartData.push(objChart);
            });
            /*
            chartData.push({'name': "HC_FCST", type:'line', stack:'总量', data:["82", "81","82"]});
            chartData.push({ 'name': "HC_Actual", type: 'line', stack: '总量', data: ["108", "108", "103"] });
            chartData.push({ 'name': "HC_Utilization", 'yAxisIndex':1, type: 'line', stack: '总量', data: ["88.17", "87.10", "103"] });
            */
            return chartData;
        }
        function RefreshChart() {
            var chartData = MakeChartData();
            var xCols = MakexAxis();
            var option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'// 默认为直线，可选为：'line' | 'shadow'
                    }
                },
                title: {
                    text: 'Weekly Trend',
                },
                legend: {
                    data: weekData.kinds,
                    type: 'scroll',
                    right: '20px',
                    align: 'right',
                    orient: 'vertical',
                    x: 'right', y: 'center',
                    textStyle: {
                        fontWeight: 'bold'
                    },
                },
                grid: {
                    left: '2%',
                    right: '10%',
                    bottom: '2%',
                    containLabel: true
                },
                xAxis: [{
                    type: 'category',
                    data: xCols
                }],
                yAxis: [{
                    type: 'value',
                    axisLabel : { formatter: '{value}'}
                },{
                    type: 'value',
                    //name: 'HC Util(%)',
                    axisLabel: { formatter: '{value} %' }
                }],
                series: chartData
            };
            
            weekChart.setOption(option);

        }

    </script>
}

